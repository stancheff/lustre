From d8654ae0facf01caef89d7c8001694420a61355a Mon Sep 17 00:00:00 2001
From: Shaun Tancheff <shaun.tancheff@hpe.com>
Date: Fri, 10 Mar 2023 01:23:32 -0600
Subject: [PATCH] linux-6.2/ext4-attach-jinode-in-writepages.patch

---
 fs/ext4/ext4.h  | 1 +
 fs/ext4/inode.c | 9 ++++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.h
index 4450196..8743d31 100644
--- a/fs/ext4/ext4.h
+++ b/fs/ext4/ext4.h
@@ -3120,6 +3120,7 @@ extern void ext4_mb_mark_bb(struct super_block *sb, ext4_fsblk_t block,
 		       int len, int state);
 
 /* inode.c */
+#define HAVE_LDISKFS_INFO_JINODE
 void ext4_inode_csum_set(struct inode *inode, struct ext4_inode *raw,
 			 struct ext4_inode_info *ei);
 int ext4_inode_is_fast_symlink(struct inode *inode);
diff --git a/fs/ext4/inode.c b/fs/ext4/inode.c
index 400a6c7..1cd709a 100644
--- a/fs/ext4/inode.c
+++ b/fs/ext4/inode.c
@@ -746,6 +746,10 @@ out_sem:
 				(loff_t)map->m_lblk << inode->i_blkbits;
 			loff_t length = (loff_t)map->m_len << inode->i_blkbits;
 
+			ret = ext4_inode_attach_jinode(inode);
+			if (ret)
+				return ret;
+
 			if (flags & EXT4_GET_BLOCKS_IO_SUBMIT)
 				ret = ext4_jbd2_inode_add_wait(handle, inode,
 						start_byte, length);
@@ -2999,7 +3003,9 @@ static int ext4_do_writepages(struct mpage_da_data *mpd)
 		mpd->first_page = wbc->range_start >> PAGE_SHIFT;
 		mpd->last_page = wbc->range_end >> PAGE_SHIFT;
 	}
-
+	ret = ext4_inode_attach_jinode(inode);
+	if (ret)
+		goto out_writepages;
 	ext4_io_submit_init(&mpd->io_submit, wbc);
 retry:
 	if (wbc->sync_mode == WB_SYNC_ALL || wbc->tagged_writepages)
@@ -4513,6 +4519,7 @@ int ext4_inode_attach_jinode(struct inode *inode)
 		jbd2_free_inode(jinode);
 	return 0;
 }
+EXPORT_SYMBOL(ext4_inode_attach_jinode);
 
 /*
  * ext4_truncate()
-- 
2.34.1

